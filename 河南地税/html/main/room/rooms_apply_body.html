<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>Hui</title>
		<link href="../../../css/Hui.css" rel="stylesheet" type="text/css" />
		<link rel="stylesheet" href="../../../css/fonts/iconfont.css" />
		<style type="text/css">
			.H_header_bg {
				background: #09a4de
			}
			.addh_active:active {
				background: #f5f5f5;
			}
		</style>
	</head>
	<body>
		<div class="H-padding-vertical-bottom-10"></div>
		<div class="H-flexbox-vertical" id="stap1">
			<div class="H-flex-item H-theme-background-color-white H-padding-10">
				<div class="H-padding-10">
					身份证示例
				</div>
				<div id="yulan">
					<img src="../../../image/sfz.jpg" style="width: 100%;" />
					<!--<img src="" id="yulan" style="width: 100%;"/>-->
				</div>
				<!--<div>
				<div class="H-padding-10">
				拍摄效果
				</div>
				<div>
				<img src="" id="ps" style="width: 100%"/>
				</div>
				</div>-->
				<div class="H-padding-10">
					点击加号拍照
				</div>
				<div class="addh_active H-padding-20 H-text-align-center H-border-both-after" onclick="openCamera();">
					<span class="iconfont icon-tianjia H-font-size-36 H-theme-font-color1"></span>
					<div style="display: none;">
						<!--<img src="" id="ps" style="width: 100%"/>-->
					</div>
				</div>
			</div>
			<div class="H-flex-item">
				<button onclick="openWin();" class="H-button H-width-100-percent  H-font-size-15 H-outline-none H-padding-vertical-both-12 H-padding-horizontal-both-20 H-theme-background-color1 H-theme-font-color-white H-theme-border-color1 H-theme-border-color1-click H-theme-background-color1-click H-theme-font-color1-click">
					下一步<span>(1/21)</span>
				</button>
			</div>
		</div>
		<script src="../../../script/H.js" type="text/javascript"></script>
		<script type="text/javascript" src="../../../script/zepto.min.js"></script>
		<script type="text/javascript" src="../../../script/tools/availdate-v1.0.2.js"></script>
		<script type="text/javascript">
			var imageFilter = null, imageBrowser = null, assessinfo = null, userinfo = null;
			var ImgWebUrl = 'http://218.29.85.98:8080/etax/fileAction.do'
			Zepto(function($) {
				$("#yulan img").on("click", function(compressImg) {
					// 调用图片预览函数
					openImageBrowser(compressImg);
				});
			});
			H.ready(function() {
				// 引入过滤压缩模块
				imageFilter = api.require("imageFilter");
				//引入图片预览模块
				imageBrowser = api.require('imageBrowser');
				H.getPrefs(function(ret, err) {
					assessinfo = eval('(' + ret.value + ')');
					console.log(JSON.stringify(ret));
				}, 'rooms');
			});
			function openWin() {
				H.openWin('rooms_payInfo_header', 'rooms_payInfo_header.html');
				setTimeout(function() {
					H.closeWin();
				}, 1000);
			}

			//生成随机文件名
			function NewGuid() {
				function S4() {
					return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
				}

				return (S4() + S4() + "-" + S4() + "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4());
			}

			// 获取文件拓展名
			function getExt(fileName) {
				return fileName.substring(fileName.lastIndexOf('.') + 1);
			}

			// 图片压缩
			// imgsrc：源图片的路径
			// quality：图片压缩质量，一般建议0.5
			// scale：图片压缩比例，也是建议0.5
			// ext：源图片拓展名
			// callback：转换成功之后回调函数
			function imgCompress(imgsrc, quality, scale, ext, callback) {
				// 压缩文件的保存目录
				var savePath = api.cacheDir + '/';
				// 压缩文件生成的随机文件名称
				var savename = NewGuid() + "." + ext;
				imageFilter.compress({
					img : imgsrc,
					quality : quality,
					scale : quality,
					save : {
						album : false,
						imgPath : savePath,
						imgName : savename
					}
				}, function(ret, err) {
					if (ret) {
						callback(savePath + savename);
					} else {
						api.toast({
							msg : err.msg
						});
					}
				});
			}

			// 打开图片预览
			function openImageBrowser(imgs) {
				imageBrowser.openImages({
					imageUrls : imgs,
					showList : false,
					activeIndex : 0
				});
			}

			// 上传图片
			// url：上传的url地址
			// data：上传的文件
			// callback：上传成功返回地址
			function uploadFile(url, data, callback) {
				H.imgAjax(function(ret, err) {
					if (ret) {
						alert('ret====' + JSON.stringify(ret));
						callback(ret);
					}
				}, url, 'post', {
					values : {
						pagetype : "editgrid",
						funid : "sys_attach",
						nousercheck : "1",
						eventcode : "create",
						dataType : "byte",
						datafunid : assessinfo.data.assessinfo_id,
						dataid : assessinfo.data.datafunid,
						attach_name : "jxstar523602"
					},
					files : {
						attach_path : data,
					}
				});
			}

			// 添加长按方法
			function addPress(obj, index) {
				// 获取目前长按的对象
				var hammertime = new Hammer(obj[0]);
				// 绑定长按对象
				hammertime.on("press", function(e) {
					api.confirm({
						title : '温馨提示',
						msg : '您确定要删除该图片吗？',
						buttons : ['确定', '取消']
					}, function(ret, err) {
						if (ret.buttonIndex == 1) {
							// 移除自己
							$(obj).remove();
							api.toast({
								msg : '删除成功！'
							});
						}
					});
				});
			}

			//打开照相机获取
			function openCamera() {
				api.getPicture({
					sourceType : 'camera',
					encodingType : 'jpg',
					mediaValue : 'pic',
					destinationType : 'url',
					allowEdit : false,
					quality : 50,
					targetWidth : 700,
					targetHeight : 400,
					saveToPhotoAlbum : false
				}, function(ret, err) {
					if (ret) {
						//												alert(JSON.stringify(ret));
						//                      $(".addh_active span").hide();
						//                      $(".addh_active div").show();
						// 拍照返回的本地路径
						var returnUrl = ret.data;
						// 图片压缩
						imgCompress(returnUrl, 0.8, 0.8, getExt(returnUrl), function(compressImg) {
							//							var showImgHtml = '<img src="' + compressImg + '" style="width:100%;"/>';
							// 追加图片
							//							$("#yulan").html(showImgHtml);
							// 为图片添加点击预览功能
							$("#yulan img").attr("src", compressImg);
							//							// ########################################
							//							// ################### 上传图片 #########################
							uploadFile(ImgWebUrl, compressImg, function(serverImg) {
								// ########################################  绑定长按事件 ########################
								//								addPress($("#imgslist img[src='" + compressImg + "']").parent("li"));
							});
						});
					} else {
						api.toast({
							msg : "用户取消"
						});
					}
				});
			}
		</script>
	</body>
</html>