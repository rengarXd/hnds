<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<title>影像资料</title>
		<link href="../../../../css/Hui.css" rel="stylesheet" type="text/css" />
		<link rel="stylesheet" href="../../../../css/fonts/iconfont.css" />
		<style type="text/css">
			.H_header_bg {
				background: #09a4de
			}
			.addh_active:active {
				background: #f5f5f5;
			}
			.del_a {
				position: absolute;
				right: 10px;
				top: 64px;
				width: 32px;
			}
			.del_b {
				position: absolute;
				right: 10px;
				width: 32px;
			}
		</style>
	</head>
	<body>
		<div class="H-padding-vertical-bottom-10"></div>
		<div class="H-flexbox-vertical" id="stap1">
			<div class="H-flex-item H-theme-background-color-white H-padding-10">
				<div class="H-padding-10" id="Leixing">
					身份证示例
				</div>
				<div id="yulan" class="H-text-align-center">
					<img src="../../../../image/loading_more.gif" style="width: 50px;display: none;margin: 50px 0;" id="loading"/>
					<img src="../../../../image/yz.png" style="width: 100%;" id="target" class="imgLast"/>
				</div>
				<div class="H-padding-10" id="addpic">
					点击加号拍照(横屏拍摄)
				</div>
				<div class="addh_active H-padding-20 H-text-align-center H-border-both-after" onclick="openCamera();">
					<span class="iconfont icon-tianjia H-font-size-36 H-theme-font-color1"></span>
					<div style="display: none;"></div>
				</div>
			</div>
			<div class="H-flex-item">
				<div class="footer"></div>
				<footer class="H-footer H-padding-10">
					<button onclick="nextPart();" class="H-margin-vertical-top-10 H-position-static H-button H-width-100-percent  H-font-size-15 H-outline-none H-padding-vertical-both-12 H-padding-horizontal-both-20 H-theme-background-color1 H-theme-font-color-white H-theme-border-color1 H-theme-background-color1-click H-theme-font-color1-click ">
						下一步(6/6)
					</button>
				</footer>
			</div>
		</div>
		<script type="text/javascript" src="../../../../script/H.js"></script>
		<script type="text/javascript" src="../../../../script/zepto.min.js"></script>
		<script type="text/javascript" src="../../../../script/tools/availdate-v1.0.2.js"></script>
		<script type="text/javascript" src="../../../../script/uploadimg/upImg.js"></script>
		<script type="text/javascript">
			var assessinfo = null, clfxsxxb_id = null, imageFilter = null, imageBrowser = null, zhonglei = null, ii = 1, jsonstr = null, userinfo = null, imgBoolean = true;
			var ImgWebUrl = 'http://218.29.85.98:8080/etax/fileAction.do';
			//			var postUrl = 'http://218.29.85.98:8080/etax/fileAction.do?eventcode=appHouseAssessSubmit&funid=houses_assessinfo&pagetype=grid&nousercheck=1';
			Zepto(function($) {
			});
			H.ready(function() {
				assessinfo_id = api.pageParam.assessinfo_id;
				H.getUserPref(function() {
				});
				initData();
				// 引入过滤压缩模块
				imageFilter = api.require('imageFilter');
				//引入图片预览模块
				imageBrowser = api.require('imageBrowser');
			});
			//模拟数据传输
			function initData() {
				H.ajax(function(ret, err) {
					if (ret.success) {
						zhonglei = ret.data;
						$("#Leixing").html(zhonglei[0].business_name);
						$("button").html('上传附件(4/' + parseInt(4 + zhonglei.length - 1) + ')');
					} else if (ret.success == false) {
						alert(JSON.stringify(ret.message));
					} else {
						api.toast({
							msg : '连接错误，请检查网络配置'
						});
					}
				}, 'selHouseAttach&funid=archive_data');
			}

			//打开成功页
			function openWin() {
				api.execScript({
					name : 'sale_header',
					script : 'success();'
				});
			}

			//提交 申请
			function house_submit() {
				H.ajax(function(ret, err) {
					api.hideProgress();
//					console.log(JSON.stringify(ret));
					ret.success ? openWin() : api.toast({
						msg : ret.message
					});
				}, 'audit&funid=wbjh_clfxsxxb&dataType=json&auditvalue=1&tag=1', 'post', {
					values : {
						user_id : userinfo[0].user_id,
						uuid : userinfo[0].uuid,
						keyid : assessinfo_id,
					}
				});
			}

			var a = 0;
			var c = $('.imgLast').size();
			var upimgs = null;
			var imgAray = new Array();
			function cyecleAJ(zhonglei, ii) {
				api.showProgress({
					title : '上传中..'
				});
				for (var a = 0; a < c; a++) {
					$('.imgLast').each(function(a) {
						imgAray.push($(this).attr('src'));
						upimgs = $(this).attr('src');
						H.ajax(function(ret, err) {
							var imgInfo = ret.data;
							uploadFile(ImgWebUrl, upimgs, imgInfo, function(serverImg) {
//								console.log('serverImg===' + JSON.stringify(serverImg))
							});
						}, 'addHouseAttach&funid=wbjh_clfxsxxb_attachs', 'post', {
							values : {
								'user_id' : userinfo[0].user_id,
								'uuid' : userinfo[0].uuid,
								'fwuuid' : assessinfo_id,
								'business_name' : zhonglei[ii].business_name,
								'business_typeid' : zhonglei[ii].business_typeid,
								'pagenum' : a + 1
							}
						});
					});
					return H.setPrefs(function(ret, err) {
//						console.log(imgAray);
					}, 'imgAray', imgAray);
				}
				api.hideProgress();
			}

			//下一步
			function nextPart() {
				var imgurl = $("#target").attr("src");
				// ################### 上传图片 #########################
				var oldurl = "../../../../image/yz.png";
				var loadurl = "../../../../image/loading_more.gif";
				if (zhonglei !== null && imgurl != oldurl && imgurl != loadurl) {
					var len = zhonglei.length;
					if (ii < len) {
						cyecleAJ(zhonglei, ii);
						$("#Leixing").html(zhonglei[ii].business_name);
						imgBoolean = true;
						$("img").parent().remove();
						$("#Leixing").after('<div id="yulan" class="H-text-align-center"><img src="../../../../image/yz.png" style="width: 100%;" id="target" class="imgLast"/><img src="../../../../image/loading_more.gif" style="width: 50px;display: none;margin: 50px 0;" id="loading"/></div>');
						var nums = '上传附件(' + parseInt(4 + ii) + '/' + parseInt(4 + len - 1) + ')';
						$("button").html(nums);
						ii++;
						api.hideProgress();
					} else {
						api.confirm({
							title : '代开发票申请提交',
							msg : '恭喜您已经上传完成所有附件，确认提交全部信息吗？',
							buttons : ['确定', '取消']
						}, function(ret, err) {
							if (ret) {
								if (ret.buttonIndex == 1) {
									house_submit();
								}
								//									console.log('ret===' + JSON.stringify(ret));
							} else {
								api.hideProgress();
								alert(JSON.stringify(err));
							}
						});
					}
				} else {
					api.toast({
						msg : '上传失败，请确认拍照图片是否正确。'
					});
				}
			}

			function select(obj) {
				api.confirm({
					title : '删除图片',
					msg : '确定删除此图片吗？',
					buttons : ['确定', '取消']
				}, function(ret, err) {
					if (ret) {
						if (ret.buttonIndex == 1) {
							H.removePrefs(function(ret, err) {
								$('.imgLast').each(function() {
									imgAray.push($(this).attr('src'));
								});
							}, 'imgAray');
							$(obj).parent().remove();
							if ($('.imgLast').size() < 1) {
								$("#Leixing").after('<div id="yulan" class="H-text-align-center"><img src="../../../../image/yz.png" style="width: 100%;" id="target" class="imgLast"/><img src="../../../../image/loading_more.gif" style="width: 50px;display: none;margin: 50px 0;" id="loading"/></div>');
								imgBoolean = true;
							}
						}
						//console.log('ret===' + JSON.stringify(ret));
					} else {
						api.hideProgress();
						alert(JSON.stringify(err));
					}
				});
			}

			// 上传图片
			// url：上传的url地址
			// data：上传的文件
			// callback：上传成功返回地址
			function uploadFile(url, dataSrc, imgInfo, callback) {
				H.oldAjax(function(ret, err) {
					if (ret) {
						ret.success ? callback(ret) : H.toast(ret.message);
					} else {
						api.hideProgress();
						H.toast('连接错误，请检查网络配置等问题');
					}
				}, url, "post", {
					values : {
						pagetype : "editgrid",
						funid : "sys_attach",
						nousercheck : "1",
						eventcode : "create",
						dataType : "byte",
						datafunid : imgInfo.datafunid,
						fileField : imgInfo.fileField,
						dataid : imgInfo.dkfp_id,
						attach_name : dataSrc
					},
					files : {
						attach_path : dataSrc,
					}
				});
			}

			//打开照相机获取
			function openCamera() {
				img.openCamera({
					sourceType : 'camera',
					encodingType : 'jpg',
					mediaValue : 'pic',
					destinationType : 'url',
					allowEdit : false,
					quality : 100,
					saveToPhotoAlbum : false
				}, function(ret) {
					//					alert(JSON.stringify(ret));
					var returnUrl = ret.data;
					if (returnUrl !== "") {
						var browerImgs = [];
						if (imgBoolean) {
							// 图片压缩
							$("#target").hide();
							$("#loading").show();
							img.imgCompress(returnUrl, 0.5, 0.5, img.getExt(returnUrl), function(compressImg) {
								$("#loading").hide();
								imgBoolean = false;
								var del = '	<img src="../../../../image/del.jpg" class="del_a" onclick="select(this);"/>'
								$("#target").attr({
									"src" : compressImg,
									"style" : "width:100%;"
								}).on("click", function() {
									// 将图片追加到数组中
									browerImgs.push($("#target").attr("src"));
									// 调用图片预览函数
									img.openImageBrowser(browerImgs);
								}).after(del);
							});
						} else {
							img.imgCompress(returnUrl, 0.5, 0.5, img.getExt(returnUrl), function(compressAddImg) {
								imgBoolean = false;
								var showImgHtml = '<div class="H-text-align-center"><img src=' + compressAddImg + ' class="imgyulan imgLast" style="width: 100%;"/><img src="../../../../image/del.jpg" onclick="select(this);" class="del_b"/></div>';
								// 追加图片
								$("#addpic").before(showImgHtml);
								$(".H-flex-item .imgyulan").eq($(this).index()).on("click", function() {
									// 将图片追加到数组中
									browerImgs.push(compressAddImg);
									// 调用图片预览函数
									img.openImageBrowser(browerImgs);
								});
							});
						}
					}
				}, '用户取消');
			}
		</script>
	</body>
</html>